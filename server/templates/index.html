<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Robot Dashboard</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial;margin:20px;background:#111;color:#0f0}
    #log{height:150px;overflow-y:scroll;border:1px solid #0f0;padding:5px;font-size:12px}
    button{margin:5px;padding:8px 12px}
    #gauges{display:flex;justify-content:center;gap:40px;margin:20px 0}
    canvas.gauge{width:200px!important;height:120px!important}
    #telemetry{display:flex;flex-wrap:wrap;gap:20px;margin:20px 0}
    .tele-item{background:#222;padding:10px;border:1px solid #0f0;border-radius:5px;min-width:120px}
    #sensors{display:flex;flex-wrap:wrap;gap:10px;margin:20px 0}
    .sensor{background:#222;padding:5px;border:1px solid #0f0;border-radius:3px;width:60px;text-align:center}
  </style>
</head>
<body>
  <h2>Robot Dashboard – Telemetría en Vivo</h2>

  <!-- CONEXIÓN -->
  <h3>Conexión</h3>
  <div id="connection" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0">
    <select id="modeSelect">
      <option value="serial">Serial</option>
      <option value="bluetooth">Bluetooth</option>
    </select>
    <select id="deviceSelect"></select>
    <button onclick="refreshDevices()">Actualizar Dispositivos</button>
    <button onclick="connect()">Conectar</button>
    <button onclick="disconnect()">Desconectar</button>
  </div>

  <!-- GRÁFICA -->
  <canvas id="chart" height="100"></canvas>

  <!-- TACÓMETROS -->
  <div id="gauges">
    <canvas id="gaugeL" class="gauge"></canvas>
    <canvas id="gaugeR" class="gauge"></canvas>
  </div>

  <!-- TELEMETRÍA ACTUAL -->
  <div id="telemetry">
    <div class="tele-item"><strong>Dist L:</strong> <span id="distL">0.0</span> cm</div>
    <div class="tele-item"><strong>Dist R:</strong> <span id="distR">0.0</span> cm</div>
    <div class="tele-item"><strong>Velocidad:</strong> <span id="speed">0.0</span> cm/s</div>
    <div class="tele-item"><strong>Modo:</strong> <span id="mode">0</span></div>
    <div class="tele-item"><strong>Error:</strong> <span id="error">0.0</span></div>
    <div class="tele-item"><strong>Corrección:</strong> <span id="correction">0.0</span></div>
    <div class="tele-item"><strong>KP:</strong> <span id="kpVal">1.2</span></div>
    <div class="tele-item"><strong>KI:</strong> <span id="kiVal">0.0</span></div>
    <div class="tele-item"><strong>KD:</strong> <span id="kdVal">0.05</span></div>
    <div class="tele-item"><strong>Vel Base:</strong> <span id="baseSpeedVal">0.8</span></div>
  </div>

  <!-- SENSORES QTR -->
  <h3>Sensores QTR</h3>
  <div id="sensors">
    <div class="sensor">Q0: <span id="q0">0</span></div>
    <div class="sensor">Q1: <span id="q1">0</span></div>
    <div class="sensor">Q2: <span id="q2">0</span></div>
    <div class="sensor">Q3: <span id="q3">0</span></div>
    <div class="sensor">Q4: <span id="q4">0</span></div>
    <div class="sensor">Q5: <span id="q5">0</span></div>
  </div>
  <div><strong>Array QTR:</strong> <span id="qtrArray">[0,0,0,0,0,0]</span></div>

  <!-- CONTROLES -->
  <div>
    <button onclick="send({'qtr':1})">Calibrar QTR</button>
    <button onclick="send({'tune':1})">Auto-tune</button>
    <button onclick="send({'eeprom':1})">Guardar EEPROM</button>
    <button onclick="send({'tele':2})">Tele Una Vez</button>
    <button onclick="send({'tele':1})">Tele ON</button>
    <button onclick="send({'tele':0})">Tele OFF</button>
    <br><br>
    <button onclick="send({'mode':0})">Modo Línea</button>
    <button onclick="send({'mode':1})">Modo Remoto</button>
    <button onclick="send({'mode':2})">Modo Servo</button>
    <br><br>
    <label>Comando personalizado:</label>
    <input id="customCmd" type="text" placeholder='{"telemetry_enable":true}' style="width:200px">
    <button onclick="send(JSON.parse(document.getElementById('customCmd').value))">Enviar</button>
  </div>

  <!-- CONTROL REMOTO -->
  <h3>Control Remoto (Autopilot)</h3>
  <div id="remoteControl" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0">
    <div><label>Throttle (-1-1): <input id="throttle" type="number" min="-1" max="1" step="0.1" value="0"></label></div>
    <div><label>Turn (-1-1): <input id="turn" type="number" min="-1" max="1" step="0.1" value="0"></label></div>
    <button onclick="sendRemote()">Enviar Remoto</button>
  </div>

  <!-- SERVO -->
  <h3>Servo Distancia</h3>
  <div id="servoControl" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0">
    <div><label>Distancia (cm): <input id="servoDist" type="number" min="0" value="10"></label></div>
    <div><label>Ángulo (grados): <input id="servoAngle" type="number" value="0"></label></div>
    <button onclick="sendServo()">Enviar Servo</button>
  </div>

  <!-- CONFIGURACIÓN PID -->
  <h3>Configuración PID</h3>
  <div id="pidConfig" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0">
    <div><label>KP: <input id="kp" type="number" step="0.1" value="1.2"></label></div>
    <div><label>KI: <input id="ki" type="number" step="0.01" value="0.0"></label></div>
    <div><label>KD: <input id="kd" type="number" step="0.01" value="0.05"></label></div>
    <div><label>Vel Base: <input id="baseSpeed" type="number" step="0.1" value="0.8"></label></div>
    <button onclick="sendPid()">Actualizar PID</button>
  </div>

  <!-- LOG -->
  <h3>Log RX/TX</h3>
  <div id="log"></div>

<script>
const socket = io();

// ---------- GRÁFICA DE LÍNEAS ----------
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {labels:[], datasets:[
    {label:'RPM L', borderColor:'blue', data:[], fill:false, tension:0.1},
    {label:'RPM R', borderColor:'red',  data:[], fill:false, tension:0.1},
    {label:'Posición línea (cm)', borderColor:'yellow', data:[], fill:false, tension:0.1, yAxisID:'y1'},
    {label:'Bat (V)', borderColor:'green', data:[], fill:false, tension:0.1, yAxisID:'y2'},
    {label:'Distancia (cm)', borderColor:'orange', data:[], fill:false, tension:0.1, yAxisID:'y1'}
  ]},
  options:{
    responsive:true,
    scales:{
      x:{title:{display:true,text:'Tiempo (s)'}, grid:{color:'#444'}},
      y:{title:{display:true,text:'RPM'}, grid:{color:'#444'}},
      y1:{type:'linear',position:'right',title:{display:true,text:'Pos (cm)'}, grid:{drawOnChartArea:false}},
      y2:{type:'linear',position:'right',title:{display:true,text:'V'}, grid:{drawOnChartArea:false}}
    }
  }
});

// ---------- TACÓMETROS (GAUGE) ----------
function createGauge(canvas, label, color){
  return new Chart(canvas, {
    type:'doughnut',
    data:{
      labels:[label,''],
      datasets:[{data:[0,300], backgroundColor:[color,'#222'], borderWidth:0}]
    },
    options:{
      rotation:-90, circumference:180, responsive:false,
      plugins:{legend:{display:false}, tooltip:{enabled:false}}
    }
  });
}
const gaugeL = createGauge(document.getElementById('gaugeL'), 'RPM L','blue');
const gaugeR = createGauge(document.getElementById('gaugeR'), 'RPM R','red');

function updateGauge(gauge, value){
  gauge.data.datasets[0].data = [Math.min(value,300), 300-value];
  gauge.update('none');
}

// ---------- LOG ----------
function log(msg){
  const d = document.getElementById('log');
  d.innerHTML += msg + '<br>';
  d.scrollTop = d.scrollHeight;
}
socket.on('log', function(data){ log(data.data); });

// ---------- TELEMETRÍA ----------
socket.on('telemetry', function(d){
  const t = (d.timestamp / 1000.0).toFixed(2);
  chart.data.labels.push(t);
  chart.data.datasets[0].data.push(d.left.rpm);
  chart.data.datasets[1].data.push(d.right.rpm);
  chart.data.datasets[2].data.push(0);  // pos placeholder
  chart.data.datasets[3].data.push(d.battery);
  chart.data.datasets[4].data.push(d.distance);
  if(chart.data.labels.length > 300){
    chart.data.labels.shift();
    chart.data.datasets.forEach(ds=>ds.data.shift());
  }
  chart.update('none');

  // Actualiza tacómetros
  updateGauge(gaugeL, d.left.rpm);
  updateGauge(gaugeR, d.right.rpm);

  // Actualiza displays de telemetría
  document.getElementById('distL').textContent = d.left.distance.toFixed(1);
  document.getElementById('distR').textContent = d.right.distance.toFixed(1);
  document.getElementById('speed').textContent = d.velocity.toFixed(1);
  document.getElementById('mode').textContent = d.mode;
  document.getElementById('error').textContent = d.error.toFixed(2);
  document.getElementById('correction').textContent = d.correction.toFixed(2);
  document.getElementById('kpVal').textContent = d.pid[0].toFixed(2);
  document.getElementById('kiVal').textContent = d.pid[1].toFixed(2);
  document.getElementById('kdVal').textContent = d.pid[2].toFixed(2);
  document.getElementById('baseSpeedVal').textContent = d.base_speed.toFixed(2);
  document.getElementById('setpointVal').textContent = d.set_point;

  // Actualiza sensores QTR
  if(d.qtr && d.qtr.length >= 6){
    for(let i=0; i<6; i++){
      document.getElementById('q'+i).textContent = d.qtr[i];
    }
    document.getElementById('qtrArray').textContent = '[' + d.qtr.join(',') + ']';
  }
});

// ---------- ENVÍO ----------
function send(obj){
  socket.emit('cmd', obj);
}

function sendPid(){
  const pid = {
    kp: parseFloat(document.getElementById('kp').value),
    ki: parseFloat(document.getElementById('ki').value),
    kd: parseFloat(document.getElementById('kd').value)
  };
  const base_speed = parseFloat(document.getElementById('baseSpeed').value);
  send({pid: [pid.kp, pid.ki, pid.kd], base_speed: base_speed});
}

function sendRemote(){
  const rc = {};
  const throttle = parseFloat(document.getElementById('throttle').value);
  const turn = parseFloat(document.getElementById('turn').value);
  if (throttle != 0) rc.throttle = throttle;
  if (turn != 0) rc.turn = turn;
  send({rc: rc});
}

function sendServo(){
  const distance = parseFloat(document.getElementById('servoDist').value);
  const angle = parseFloat(document.getElementById('servoAngle').value);
  send({servo: {distance: distance, angle: angle}});
}

function refreshDevices(){
  const mode = document.getElementById('modeSelect').value;
  fetch('/devices')
    .then(r => r.json())
    .then(devices => {
      const select = document.getElementById('deviceSelect');
      select.innerHTML = '';
      devices.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.port;
        opt.textContent = `${d.port} - ${d.desc}`;
        select.appendChild(opt);
      });
    });
}

function setMode(){
  const mode = document.getElementById('modeSelect').value;
  fetch('/set_mode', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({mode: mode})
  }).then(() => refreshDevices());
}

function connect(){
  const device = document.getElementById('deviceSelect').value;
  if (device) {
    socket.emit('connect_device', {device: device});
  }
}

function disconnect(){
  socket.emit('disconnect_serial');
}

// Load devices on page load
window.onload = function(){
  document.getElementById('modeSelect').addEventListener('change', setMode);
  refreshDevices();
};
</script>
</body>
</html>