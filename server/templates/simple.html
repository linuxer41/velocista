<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mini PID Sender</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body{font-family:Arial;margin:10px;background:#111;color:#fff;font-size:14px}
    h2,h3{margin:5px 0;color:#fff}
    #connection,#pidConfig{display:flex;flex-wrap:wrap;gap:5px;margin:5px 0}
    label{display:flex;align-items:center;gap:3px;color:#fff;font-size:12px}
    input,select{background:#222;color:#fff;border:1px solid #fff;padding:3px;width:80px;font-size:12px}
    button{margin:2px;padding:5px 8px;background:#333;color:#fff;border:1px solid #fff;cursor:pointer;font-size:12px}
    button:hover{background:#444}
    #log{height:150px;overflow-y:scroll;border:1px solid #fff;padding:3px;font-size:11px;background:#000;color:#fff;margin:5px 0}
    @media (max-width:600px){body{margin:5px}#connection,#pidConfig{flex-direction:column}input,select{width:100%}}
  </style>
</head>
<body>
  <h2>Mini PID Sender</h2>

  <!-- CONEXIÓN -->
  <h3>Conexión</h3>
  <div id="connection" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0">
    <select id="deviceSelect"></select>
    <button onclick="refreshDevices()">Actualizar Dispositivos</button>
    <button onclick="connect()">Conectar</button>
    <button onclick="disconnect()">Desconectar</button>
  </div>

  <!-- CONFIGURACIÓN PID -->
  <h3>Enviar PID</h3>
  <div id="pidConfig" style="margin:10px 0">
    <label>Kp: <input id="kp" type="number" step="0.01" value="0.15"></label><br>
    <label>Ki: <input id="ki" type="number" step="0.01" value="0.01"></label><br>
    <label>Kd: <input id="kd" type="number" step="0.01" value="0.02"></label><br>
    <label>Speed: <input id="speed" type="number" value="180"></label><br>
    <button onclick="sendPid()">Enviar PID</button>
    <br><br>
    <button onclick="send({calibrate:1})">Calibrar</button>
    <button onclick="send({telemetry:1})">Telemetría</button>
  </div>

  <!-- LOG -->
  <h3>Log RX/TX</h3>
  <div id="log"></div>

<script>
const socket = io();

// ---------- LOG ----------
function log(msg){
  const d = document.getElementById('log');
  d.innerHTML += msg + '<br>';
  d.scrollTop = d.scrollHeight;
}
socket.on('log', function(data){ log('RX: ' + data.data); });

// ---------- ENVÍO ----------
function send(obj){
  log('TX: ' + JSON.stringify(obj));
  socket.emit('cmd', obj);
}

function sendPid(){
  const kp = parseFloat(document.getElementById('kp').value);
  const ki = parseFloat(document.getElementById('ki').value);
  const kd = parseFloat(document.getElementById('kd').value);
  const speed = parseFloat(document.getElementById('speed').value);
  send({pid: [kp, ki, kd], base_speed: speed});
}

function refreshDevices(){
  fetch('/devices')
    .then(r => r.json())
    .then(devices => {
      const select = document.getElementById('deviceSelect');
      select.innerHTML = '';
      devices.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.port;
        opt.textContent = `${d.port} - ${d.desc}`;
        select.appendChild(opt);
      });
    });
}

function connect(){
  const device = document.getElementById('deviceSelect').value;
  if (device) {
    socket.emit('connect_device', {device: device});
  }
}

function disconnect(){
  socket.emit('disconnect_serial');
}

// Load devices on page load
window.onload = function(){
  refreshDevices();
};
</script>
</body>
</html>